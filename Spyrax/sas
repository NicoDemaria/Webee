{
    "aggregate": [
        {
            "$match": {
                "deviceId": {
                    "$in": [
                        {
                            "$oid": "61dd8bbd16798400113960c0"
                        },
                        {
                            "$oid": "61dd885c6717cf00117ff41d"
                        },
                        {
                            "$oid": "614205233b9e9d001893add0"
                        },
                        {
                            "$oid": "63723324c024f700112089fc"
                        },
                        {
                            "$oid": "61420c32cc691e0018cb65d1"
                        },
                        {
                            "$oid": "61dd895641d8c000112fa77f"
                        },
                        {
                            "$oid": "6142048a3b9e9d001893adc0"
                        },
                        {
                            "$oid": "6142056d986a0900188f063d"
                        },
                        {
                            "$oid": "6142054d3b9e9d001893add1"
                        }
                    ]
                }
            }
        },
        {
            "$project": {
                "_id": 0,
                "deviceId": 1,
                "deviceName": 1,
                "createdAt": 1,
                "range": 1,
                "var": {
                    "$switch": {
                        "branches": [
                            {
                                "case": {
                                    "$eq": [
                                        "@urlParam.var@",
                                        "presionCaldera"
                                    ]
                                },
                                "then": "$mappedValue"
                            }
                        ],
                        "default": "-"
                    }
                }
            }
        },
        {
            "$sort": {
                "createdAt": -1
            }
        },
        {
            "$group": {
                "_id": {
                    "device": "$deviceId",
                    "date": {
                        "$dateFromParts": {
                            "year": {
                                "$year": "$createdAt"
                            },
                            "month": {
                                "$month": "$createdAt"
                            },
                            "day": {
                                "$dayOfMonth": "$createdAt"
                            },
                            "hour": {
                                "$hour": "$createdAt"
                            },
                            "minute": {
                                "$subtract": [
                                    {
                                        "$minute": "$createdAt"
                                    },
                                    {
                                        "$mod": [
                                            {
                                                "$minute": "$createdAt"
                                            },
                                            15
                                        ]
                                    }
                                ]
                            }
                        }
                    }
                },
                "deviceName": {
                    "$first": "$deviceName"
                },
                "firstSeen": {
                    "$last": "$createdAt"
                },
                "lastSeen": {
                    "$first": "$createdAt"
                },
                "range": {
                    "$first": "$range"
                },
                "varSeries": {
                    "$push": {
                        "$cond": {
                            "if": {
                                "$ne": [
                                    "$var",
                                    "-"
                                ]
                            },
                            "then": {
                                "name": "$createdAt",
                                "value": "$var"
                            },
                            "else": "$$REMOVE"
                        }
                    }
                }
            }
        },
        {
            "$set": {
                "device": {
                    "$arrayElemAt": [
                        "$device.name",
                        0
                    ]
                }
            }
        },
        {
            "$bucketAuto": {
                "groupBy": "$_id.device",
                "buckets": 1,
                "output": {
                    "var": {
                        "$push": {
                            "name": "$_id.date",
                            "value": {
                                "$avg": "$varSeries.value"
                            },
                            "min": {
                                "$min": "$varSeries.value"
                            },
                            "max": {
                                "$max": "$varSeries.value"
                            }
                        }
                    },
                    "range": {
                        "$first": "$range"
                    }
                }
            }
        },
        {
            "$set": {
                "param": "@urlParam.var@"
            }
        }
    ]
}